@rendermode InteractiveServer
@using TruequeTextil.Features.Admin.Interfaces
@inject IAdminService AdminService
@inject TruequeTextil.Shared.Services.CustomAuthenticationStateProvider AuthStateProvider
@inject NavigationManager NavigationManager

<div>
    <div class="d-flex align-items-center justify-content-between mb-3">
        <div class="d-flex align-items-center gap-3">
            <div class="bg-amber-600 rounded-3 d-flex align-items-center justify-content-center" style="width: 2.5rem; height: 2.5rem;">
                <i class="bi bi-flag text-white"></i>
            </div>
            <div>
                <h1 class="text-dark fs-2 fw-semibold mb-0">Gestion de Reportes</h1>
                <p class="text-muted small mb-0">Revisa y administra los reportes de la comunidad</p>
            </div>
        </div>

        <div class="d-flex gap-2">
            <select @bind="filtroEstado" @bind:after="CargarReportes"
                class="form-select" style="border-radius: 0.5rem;">
                <option value="todos">Todos los estados</option>
                <option value="pendiente">Pendiente</option>
                <option value="revisado">Revisado</option>
                <option value="resuelto">Resuelto</option>
                <option value="desestimado">Desestimado</option>
            </select>

            <select @bind="filtroTipo" @bind:after="CargarReportes"
                class="form-select" style="border-radius: 0.5rem;">
                <option value="todos">Todos los tipos</option>
                <option value="usuario">Usuario</option>
                <option value="prenda">Prenda</option>
            </select>
        </div>
    </div>

    <!-- Estadisticas de reportes -->
    <div class="row row-cols-1 row-cols-md-4 g-3 mb-3">
        <div class="col">
            <div class="card bg-white border rounded-3 p-3 shadow-sm">
                <div class="d-flex align-items-center gap-3">
                    <div class="bg-warning rounded-circle d-flex align-items-center justify-content-center text-white"
                          style="width: 3rem; height: 3rem;">
                        <i class="bi bi-flag"></i>
                    </div>
                    <div>
                        <p class="text-muted small mb-1">Pendientes</p>
                        <p class="text-dark fs-5 mb-0">@estadisticas.Pendientes</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="col">
            <div class="card bg-white border rounded-3 p-3 shadow-sm">
                <div class="d-flex align-items-center gap-3">
                    <div class="bg-info rounded-circle d-flex align-items-center justify-content-center text-white"
                          style="width: 3rem; height: 3rem;">
                        <i class="bi bi-eye"></i>
                    </div>
                    <div>
                        <p class="text-muted small mb-1">Revisados</p>
                        <p class="text-dark fs-5 mb-0">@estadisticas.Revisados</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="col">
            <div class="card bg-white border rounded-3 p-3 shadow-sm">
                <div class="d-flex align-items-center gap-3">
                    <div class="bg-success rounded-circle d-flex align-items-center justify-content-center text-white"
                          style="width: 3rem; height: 3rem;">
                        <i class="bi bi-check-circle"></i>
                    </div>
                    <div>
                        <p class="text-muted small mb-1">Resueltos</p>
                        <p class="text-dark fs-5 mb-0">@estadisticas.Resueltos</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="col">
            <div class="card bg-white border rounded-3 p-3 shadow-sm">
                <div class="d-flex align-items-center gap-3">
                    <div class="bg-danger rounded-circle d-flex align-items-center justify-content-center text-white"
                          style="width: 3rem; height: 3rem;">
                        <i class="bi bi-x-circle"></i>
                    </div>
                    <div>
                        <p class="text-muted small mb-1">Desestimados</p>
                        <p class="text-dark fs-5 mb-0">@estadisticas.Desestimados</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @if (cargando)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-amber-600" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
        </div>
    }
    else if (!reportes.Any())
    {
        <div class="card bg-white border rounded-3 p-5 text-center shadow-sm">
            <i class="bi bi-inbox text-muted fs-1 mb-3"></i>
            <p class="text-muted">No hay reportes que mostrar</p>
        </div>
    }
    else
    {
        <!-- Lista de reportes -->
        <div class="d-flex flex-column gap-3">
            @foreach (var reporte in reportes)
            {
                <div class="card bg-white border rounded-3 overflow-hidden shadow-sm">
                    <div class="card-header bg-light p-3">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center gap-3">
                                <div class="@GetTipoClass(reporte.Tipo.ToString()) rounded-circle d-flex align-items-center justify-content-center"
                                      style="width: 2.5rem; height: 2.5rem;">
                                    <i class="bi @GetTipoIcono(reporte.Tipo.ToString()) text-white"></i>
                                </div>

                                <div>
                                    <h3 class="text-dark mb-1 h6">Reporte de @reporte.Tipo.ToString()</h3>
                                    <div class="d-flex align-items-center gap-2 small">
                                        <span class="@GetEstadoClass(reporte.Estado.ToString()) px-2 py-1 rounded-pill">
                                            @reporte.Estado.ToString()
                                        </span>
                                        <span class="text-muted">â€¢</span>
                                        <span class="text-muted">@FormatearFecha(reporte.FechaCreacion)</span>
                                    </div>
                                </div>
                            </div>

                            <button @onclick="() => ToggleExpandirReporte(reporte.ReporteId)" class="btn btn-link text-muted p-0">
                                <i class="bi @(reportesExpandidos.Contains(reporte.ReporteId) ? "bi-chevron-up" : "bi-chevron-down")"></i>
                            </button>
                        </div>
                    </div>

                    @if (reportesExpandidos.Contains(reporte.ReporteId))
                    {
                        <div class="card-body p-3">
                            <div class="row g-3 mb-3">
                                <div class="col-md-6">
                                    <p class="text-muted small mb-1">Reportado por</p>
                                    <div class="d-flex align-items-center gap-2">
                                        <div class="bg-amber-600 rounded-circle d-flex align-items-center justify-content-center text-white small"
                                              style="width: 2rem; height: 2rem;">
                                            @(reporte.UsuarioReportante?.Nombre?.Length > 0 ? reporte.UsuarioReportante.Nombre[0].ToString().ToUpper() : "?")
                                        </div>
                                        <span class="text-dark">@(reporte.UsuarioReportante?.Nombre ?? "") @(reporte.UsuarioReportante?.Apellido ?? "")</span>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <p class="text-muted small mb-1">Motivo</p>
                                    <p class="text-dark mb-0">@reporte.Motivo</p>
                                </div>
                            </div>

                            @if (!string.IsNullOrEmpty(reporte.Descripcion))
                            {
                                <div class="mb-3">
                                    <p class="text-muted small mb-1">Descripcion</p>
                                    <p class="text-dark bg-light p-3 rounded-2 mb-0">@reporte.Descripcion</p>
                                </div>
                            }

                            <div class="mb-3">
                                <p class="text-muted small mb-1">Elemento reportado</p>
                                <div class="bg-light p-3 rounded-2">
                                    <div class="d-flex align-items-center gap-3">
                                        @if (reporte.Tipo == TruequeTextil.Shared.Models.TipoReporte.Usuario && reporte.UsuarioReportado != null)
                                        {
                                            <div class="bg-amber-600 rounded-circle d-flex align-items-center justify-content-center text-white"
                                                  style="width: 2.5rem; height: 2.5rem;">
                                                @(reporte.UsuarioReportado.Nombre?.Length > 0 ? reporte.UsuarioReportado.Nombre[0].ToString().ToUpper() : "?")
                                            </div>
                                            <div>
                                                <p class="text-dark mb-0">@reporte.UsuarioReportado.Nombre @reporte.UsuarioReportado.Apellido</p>
                                                <p class="small text-muted mb-0">ID: @reporte.UsuarioReportadoId</p>
                                            </div>
                                        }
                                        else if (reporte.Tipo == TruequeTextil.Shared.Models.TipoReporte.Prenda && reporte.PrendaReportada != null)
                                        {
                                            <div class="bg-light rounded-3 d-flex align-items-center justify-content-center border"
                                                  style="width: 2.5rem; height: 2.5rem;">
                                                <i class="bi bi-bag text-muted"></i>
                                            </div>
                                            <div>
                                                <p class="text-dark mb-0">@reporte.PrendaReportada.Titulo</p>
                                                <p class="small text-muted mb-0">ID: @reporte.PrendaReportadaId</p>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>

                            @if (!string.IsNullOrEmpty(mensajeAccion) && reporteEnAccion == reporte.ReporteId)
                            {
                                <div class="alert @(exitoAccion ? "alert-success" : "alert-danger") small mb-3">
                                    @mensajeAccion
                                </div>
                            }

                            @{
                                var tipoUsuario = "usuario";
                                var tipoPrenda = "prenda";
                                var estadoRevisado = "revisado";
                                var estadoResuelto = "resuelto";
                                var estadoDesestimado = "desestimado";
                            }
                            <div class="d-flex gap-2 flex-wrap">
                                @if (reporte.Tipo == TruequeTextil.Shared.Models.TipoReporte.Usuario && reporte.UsuarioReportadoId.HasValue)
                                {
                                    var usuarioId = reporte.UsuarioReportadoId.Value;
                                    <button @onclick="() => VerElementoReportado(tipoUsuario, usuarioId)"
                                        class="btn bg-stone-700 text-white btn-sm">
                                        <i class="bi bi-person me-1"></i> Ver perfil
                                    </button>
                                }
                                else if (reporte.Tipo == TruequeTextil.Shared.Models.TipoReporte.Prenda && reporte.PrendaReportadaId.HasValue)
                                {
                                    var prendaId = reporte.PrendaReportadaId.Value;
                                    <button @onclick="() => VerElementoReportado(tipoPrenda, prendaId)"
                                        class="btn bg-stone-700 text-white btn-sm">
                                        <i class="bi bi-bag me-1"></i> Ver prenda
                                    </button>
                                }

                                @if (reporte.Estado == TruequeTextil.Shared.Models.EstadoReporte.Pendiente)
                                {
                                    var reporteId = reporte.ReporteId;
                                    <button @onclick="() => CambiarEstadoReporte(reporteId, estadoRevisado)"
                                        class="btn btn-info btn-sm" disabled="@procesando">
                                        <i class="bi bi-eye me-1"></i> Marcar revisado
                                    </button>

                                    <button @onclick="() => AbrirModalAprobar(reporte)"
                                        class="btn btn-success btn-sm" disabled="@procesando">
                                        <i class="bi bi-check me-1"></i> Aprobar
                                    </button>

                                    <button @onclick="() => AbrirModalRechazar(reporte)"
                                        class="btn btn-outline-danger btn-sm" disabled="@procesando">
                                        <i class="bi bi-x me-1"></i> Rechazar
                                    </button>
                                }
                                else if (reporte.Estado == TruequeTextil.Shared.Models.EstadoReporte.Revisado)
                                {
                                    var reporteId = reporte.ReporteId;
                                    <button @onclick="() => AbrirModalAprobar(reporte)"
                                        class="btn btn-success btn-sm" disabled="@procesando">
                                        <i class="bi bi-check me-1"></i> Aprobar
                                    </button>

                                    <button @onclick="() => AbrirModalRechazar(reporte)"
                                        class="btn btn-outline-danger btn-sm" disabled="@procesando">
                                        <i class="bi bi-x me-1"></i> Rechazar
                                    </button>
                                }
                            </div>
                        </div>
                    }
                </div>
            }
        </div>

        <!-- Paginacion -->
        @if (totalPaginas > 1)
        {
            <div class="d-flex justify-content-between align-items-center mt-3">
                <div class="text-muted">
                    Mostrando @((paginaActual - 1) * porPagina + 1)-@Math.Min(paginaActual * porPagina, totalReportes) de @totalReportes reportes
                </div>

                <nav>
                    <ul class="pagination pagination-sm mb-0">
                        <li class="page-item @(paginaActual == 1 ? "disabled" : "")">
                            <button class="page-link" @onclick="() => CambiarPagina(paginaActual - 1)" disabled="@(paginaActual == 1)">Anterior</button>
                        </li>
                        @for (int i = 1; i <= Math.Min(5, totalPaginas); i++)
                        {
                            var pagina = i;
                            <li class="page-item @(paginaActual == pagina ? "active" : "")">
                                <button class="page-link" @onclick="() => CambiarPagina(pagina)">@pagina</button>
                            </li>
                        }
                        <li class="page-item @(paginaActual == totalPaginas ? "disabled" : "")">
                            <button class="page-link" @onclick="() => CambiarPagina(paginaActual + 1)" disabled="@(paginaActual == totalPaginas)">Siguiente</button>
                        </li>
                    </ul>
                </nav>
            </div>
        }
    }

    <!-- Modal de aprobacion -->
    @if (mostrarModalAprobar && reporteAProbar != null)
    {
        <div class="modal d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content bg-white border rounded-3">
                    <div class="modal-header">
                        <h5 class="modal-title text-dark">Aprobar Reporte</h5>
                        <button type="button" class="btn-close" @onclick="CerrarModalAprobar"></button>
                    </div>

                    <div class="modal-body p-3">
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle me-2"></i>
                            Al aprobar este reporte se ejecutaran las siguientes acciones automaticas:
                            <ul class="mb-0 mt-2">
                                @if (reporteAProbar.Tipo == TruequeTextil.Shared.Models.TipoReporte.Usuario)
                                {
                                    <li>El usuario reportado sera suspendido</li>
                                    <li>Se notificara al reportador</li>
                                }
                                else if (reporteAProbar.Tipo == TruequeTextil.Shared.Models.TipoReporte.Prenda)
                                {
                                    <li>La prenda reportada sera desactivada</li>
                                    <li>Se notificara al reportador</li>
                                }
                            </ul>
                        </div>

                        <p class="text-dark mb-3">
                            <strong>Motivo:</strong> @reporteAProbar.Motivo
                        </p>

                        <div class="mb-3">
                            <label class="form-label text-muted small">Comentario (opcional)</label>
                            <textarea @bind="comentarioAccion" class="form-control"
                                rows="3" placeholder="Agrega un comentario sobre esta decision..."></textarea>
                        </div>

                        @if (!string.IsNullOrEmpty(mensajeErrorAccion))
                        {
                            <div class="alert alert-danger small">@mensajeErrorAccion</div>
                        }
                        @if (!string.IsNullOrEmpty(mensajeExitoAccion))
                        {
                            <div class="alert alert-success small">@mensajeExitoAccion</div>
                        }
                    </div>

                    <div class="modal-footer">
                        <button @onclick="CerrarModalAprobar" class="btn btn-secondary">
                            Cancelar
                        </button>
                        <button @onclick="ConfirmarAprobacion" class="btn btn-success" disabled="@procesandoModal">
                            @if (procesandoModal)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                            }
                            <i class="bi bi-check-circle me-1"></i> Confirmar aprobacion
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Modal de rechazo -->
    @if (mostrarModalRechazar && reporteARechazar != null)
    {
        <div class="modal d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content bg-white border rounded-3">
                    <div class="modal-header">
                        <h5 class="modal-title text-dark">Rechazar Reporte</h5>
                        <button type="button" class="btn-close" @onclick="CerrarModalRechazar"></button>
                    </div>

                    <div class="modal-body p-3">
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            Al rechazar este reporte NO se ejecutaran acciones sobre el elemento reportado.
                            El reporte sera marcado como desestimado.
                        </div>

                        <p class="text-dark mb-3">
                            <strong>Motivo:</strong> @reporteARechazar.Motivo
                        </p>

                        <div class="mb-3">
                            <label class="form-label text-muted small">Comentario (opcional)</label>
                            <textarea @bind="comentarioAccion" class="form-control"
                                rows="3" placeholder="Explica por que se rechaza este reporte..."></textarea>
                        </div>

                        @if (!string.IsNullOrEmpty(mensajeErrorAccion))
                        {
                            <div class="alert alert-danger small">@mensajeErrorAccion</div>
                        }
                        @if (!string.IsNullOrEmpty(mensajeExitoAccion))
                        {
                            <div class="alert alert-success small">@mensajeExitoAccion</div>
                        }
                    </div>

                    <div class="modal-footer">
                        <button @onclick="CerrarModalRechazar" class="btn btn-secondary">
                            Cancelar
                        </button>
                        <button @onclick="ConfirmarRechazo" class="btn btn-danger" disabled="@procesandoModal">
                            @if (procesandoModal)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                            }
                            <i class="bi bi-x-circle me-1"></i> Confirmar rechazo
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private bool cargando = true;
    private bool procesando = false;
    private bool procesandoModal = false;
    private string filtroEstado = "todos";
    private string filtroTipo = "todos";
    private int paginaActual = 1;
    private int porPagina = 10;
    private int totalReportes = 0;
    private int totalPaginas = 0;
    private int adminId = 0;

    private string mensajeAccion = "";
    private string mensajeErrorAccion = "";
    private string mensajeExitoAccion = "";
    private string comentarioAccion = "";
    private bool exitoAccion = false;
    private int reporteEnAccion = 0;

    private TruequeTextil.Shared.Models.Reporte? reporteAProbar;
    private TruequeTextil.Shared.Models.Reporte? reporteARechazar;
    private bool mostrarModalAprobar = false;
    private bool mostrarModalRechazar = false;

    private EstadisticasReportesDTO estadisticas = new(0, 0, 0, 0);
    private List<TruequeTextil.Shared.Models.Reporte> reportes = new();
    private HashSet<int> reportesExpandidos = new();

    protected override async Task OnInitializedAsync()
    {
        var usuario = await AuthStateProvider.GetCurrentUserAsync();
        if (usuario == null || (usuario.Rol != "admin" && usuario.Rol != "administrador"))
        {
            NavigationManager.NavigateTo("/");
            return;
        }
        adminId = usuario.UsuarioId;

        await CargarDatos();
    }

    private async Task CargarDatos()
    {
        cargando = true;
        try
        {
            estadisticas = await AdminService.ObtenerEstadisticasReportes();
            await CargarReportes();
        }
        finally
        {
            cargando = false;
        }
    }

    private async Task CargarReportes()
    {
        var estado = filtroEstado == "todos" ? null : filtroEstado;
        var tipo = filtroTipo == "todos" ? null : filtroTipo;

        var (items, total, paginas) = await AdminService.ObtenerReportesPaginados(estado, tipo, paginaActual, porPagina);
        reportes = items;
        totalReportes = total;
        totalPaginas = paginas;
    }

    private async Task CambiarPagina(int pagina)
    {
        if (pagina < 1 || pagina > totalPaginas) return;
        paginaActual = pagina;
        await CargarReportes();
    }

    private void ToggleExpandirReporte(int id)
    {
        if (reportesExpandidos.Contains(id))
            reportesExpandidos.Remove(id);
        else
            reportesExpandidos.Add(id);
    }

    private async Task CambiarEstadoReporte(int reporteId, string nuevoEstado)
    {
        procesando = true;
        reporteEnAccion = reporteId;
        mensajeAccion = "";

        try
        {
            var (exito, mensaje) = await AdminService.CambiarEstadoReporte(reporteId, nuevoEstado, adminId);
            exitoAccion = exito;
            mensajeAccion = mensaje;

            if (exito)
            {
                await CargarDatos();
            }
        }
        catch (Exception ex)
        {
            exitoAccion = false;
            mensajeAccion = "Error: " + ex.Message;
        }
        finally
        {
            procesando = false;
        }
    }

    private void VerElementoReportado(string tipo, int id)
    {
        var url = tipo switch
        {
            "usuario" => $"/perfil-publico/{id}",
            "prenda" => $"/detalle-prenda/{id}",
            _ => "/admin"
        };
        NavigationManager.NavigateTo(url);
    }

    private string GetTipoClass(string tipo)
    {
        return tipo.ToLower() switch
        {
            "usuario" => "bg-info-subtle text-info",
            "prenda" => "bg-warning-subtle text-warning",
            _ => "bg-stone-700 text-stone-300"
        };
    }

    private string GetTipoIcono(string tipo)
    {
        return tipo.ToLower() switch
        {
            "usuario" => "bi-person",
            "prenda" => "bi-bag",
            _ => "bi-question"
        };
    }

    private string GetEstadoClass(string estado)
    {
        return estado.ToLower() switch
        {
            "pendiente" => "bg-warning-subtle text-warning",
            "revisado" => "bg-info-subtle text-info",
            "resuelto" => "bg-success-subtle text-success",
            "desestimado" => "bg-danger-subtle text-danger",
            _ => "bg-stone-700 text-stone-300"
        };
    }

    private string FormatearFecha(DateTime fecha)
    {
        var diferencia = DateTime.Now - fecha;
        if (diferencia.TotalMinutes < 60)
            return $"Hace {(int)diferencia.TotalMinutes} min";
        if (diferencia.TotalHours < 24)
            return $"Hace {(int)diferencia.TotalHours} horas";
        if (diferencia.TotalDays < 7)
            return $"Hace {(int)diferencia.TotalDays} dias";
        return fecha.ToString("dd/MM/yyyy");
    }

    private void AbrirModalAprobar(TruequeTextil.Shared.Models.Reporte reporte)
    {
        reporteAProbar = reporte;
        comentarioAccion = "";
        mensajeErrorAccion = "";
        mensajeExitoAccion = "";
        mostrarModalAprobar = true;
    }

    private void CerrarModalAprobar()
    {
        mostrarModalAprobar = false;
        reporteAProbar = null;
        comentarioAccion = "";
        mensajeErrorAccion = "";
        mensajeExitoAccion = "";
    }

    private async Task ConfirmarAprobacion()
    {
        if (reporteAProbar == null) return;

        procesandoModal = true;
        mensajeErrorAccion = "";

        try
        {
            var (exito, mensaje) = await AdminService.AprobarReporte(reporteAProbar.ReporteId, adminId, comentarioAccion);

            if (exito)
            {
                mensajeExitoAccion = mensaje;
                await Task.Delay(1500);
                CerrarModalAprobar();
                await CargarDatos();
            }
            else
            {
                mensajeErrorAccion = mensaje;
            }
        }
        catch (Exception ex)
        {
            mensajeErrorAccion = "Error: " + ex.Message;
        }
        finally
        {
            procesandoModal = false;
        }
    }

    private void AbrirModalRechazar(TruequeTextil.Shared.Models.Reporte reporte)
    {
        reporteARechazar = reporte;
        comentarioAccion = "";
        mensajeErrorAccion = "";
        mensajeExitoAccion = "";
        mostrarModalRechazar = true;
    }

    private void CerrarModalRechazar()
    {
        mostrarModalRechazar = false;
        reporteARechazar = null;
        comentarioAccion = "";
        mensajeErrorAccion = "";
        mensajeExitoAccion = "";
    }

    private async Task ConfirmarRechazo()
    {
        if (reporteARechazar == null) return;

        procesandoModal = true;
        mensajeErrorAccion = "";

        try
        {
            var (exito, mensaje) = await AdminService.RechazarReporte(reporteARechazar.ReporteId, adminId, comentarioAccion);

            if (exito)
            {
                mensajeExitoAccion = mensaje;
                await Task.Delay(1500);
                CerrarModalRechazar();
                await CargarDatos();
            }
            else
            {
                mensajeErrorAccion = mensaje;
            }
        }
        catch (Exception ex)
        {
            mensajeErrorAccion = "Error: " + ex.Message;
        }
        finally
        {
            procesandoModal = false;
        }
    }
}
