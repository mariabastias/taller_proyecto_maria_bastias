@page "/explorar"
@rendermode InteractiveServer
@attribute [Authorize]
@using TruequeTextil.Features.Explorar.Interfaces
@using TruequeTextil.Features.Favoritos.Interfaces
@using TruequeTextil.Shared.Models
@using TruequeTextil.Shared.Services

<div class="min-vh-100 bg-stone-50">
    <!-- Header con busqueda -->
    <div class="bg-white border-bottom border-stone-200 sticky-top">
        <div class="container" style="max-width: 1152px;">
            <div class="p-4">
                <div class="d-flex align-items-center gap-3">
                    <div class="flex-grow-1 position-relative">
                        <i class="bi bi-search position-absolute text-stone-400" style="left: 0.75rem; top: 50%; transform: translateY(-50%);"></i>
                        <input type="search" placeholder="Buscar prendas..."
                            class="form-control ps-5 pe-3 py-3 border-stone-300 rounded-3 focus-ring-amber"
                            @bind="terminoBusqueda" @bind:event="oninput" @onkeyup="OnBusquedaKeyUp" />
                    </div>
                    <button @onclick="Buscar"
                        class="btn btn-primary text-white rounded-3 p-3">
                        <i class="bi bi-search"></i>
                    </button>
                    <button @onclick="ToggleFiltros"
                        class="btn border border-stone-300 rounded-3 p-3 @(mostrarFiltros ? "bg-amber-50 border-amber-300" : "")">
                        <i class="bi bi-gear"></i>
                    </button>
                </div>

                <!-- Filtros expandibles -->
                @if (mostrarFiltros)
                {
                    <div class="mt-4 pb-4">
                        <div class="row g-3">
                            <div class="col-12 col-sm-6 col-lg-3">
                                <label class="form-label small text-stone-600">Categoria</label>
                                <select class="form-select border-stone-300 rounded-3 focus-ring-amber" @bind="categoriaId">
                                    <option value="0">Todas las categorias</option>
                                    @foreach (var cat in categorias)
                                    {
                                        <option value="@cat.CategoriaId">@cat.NombreCategoria</option>
                                    }
                                </select>
                            </div>

                            <div class="col-12 col-sm-6 col-lg-3">
                                <label class="form-label small text-stone-600">Talla</label>
                                <select class="form-select border-stone-300 rounded-3 focus-ring-amber" @bind="tallaSeleccionada">
                                    <option value="">Todas las tallas</option>
                                    @foreach (var t in tallas)
                                    {
                                        <option value="@t">@t</option>
                                    }
                                </select>
                            </div>

                            <div class="col-12 col-sm-6 col-lg-3">
                                <label class="form-label small text-stone-600">Estado</label>
                                <select class="form-select border-stone-300 rounded-3 focus-ring-amber" @bind="estadoPrendaId">
                                    <option value="0">Todos los estados</option>
                                    @foreach (var est in estadosPrenda)
                                    {
                                        <option value="@est.EstadoId">@est.NombreEstado</option>
                                    }
                                </select>
                            </div>

                            <div class="col-12 col-sm-6 col-lg-3">
                                <label class="form-label small text-stone-600">Region</label>
                                <select class="form-select border-stone-300 rounded-3 focus-ring-amber" @bind="regionId">
                                    <option value="0">Todas las regiones</option>
                                    @foreach (var r in regiones)
                                    {
                                        <option value="@r.RegionId">@r.NombreRegion</option>
                                    }
                                </select>
                            </div>
                        </div>

                        <div class="d-flex gap-2 mt-3">
                            <button @onclick="Buscar" class="btn btn-primary text-white rounded-3 px-4">
                                <i class="bi bi-search me-2"></i>Aplicar filtros
                            </button>
                            <button @onclick="LimpiarFiltros" class="btn btn-outline-secondary rounded-3 px-4">
                                <i class="bi bi-x-circle me-2"></i>Limpiar
                            </button>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- Contenido principal -->
    <div class="container" style="max-width: 1152px;">
        <div class="p-4">
            @if (cargando)
            {
                <div class="text-center py-5">
                    <div class="spinner-border text-amber-600" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>
            }
            else
            {
                <!-- Seccion de prendas -->
                <div class="mb-5">
                    <div class="d-flex align-items-center justify-content-between mb-4">
                        <h2 class="h5 fw-semibold text-stone-900 mb-0">Descubre prendas para intercambiar</h2>
                        <span class="small text-stone-500">@resultado.TotalCount prendas disponibles</span>
                    </div>

                    @if (resultado.Items.Any())
                    {
                        <!-- Grid de prendas -->
                        <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 row-cols-xl-4 g-4">
                            @foreach (var prenda in resultado.Items)
                            {
                                <div class="col">
                                    <div @onclick="() => VerDetallePrenda(prenda.PrendaId)"
                                        class="card border border-stone-200 rounded-4 h-100 cursor-pointer hover-shadow-lg hover-border-amber">
                                        <!-- Imagen -->
                                        <div class="position-relative" style="padding-top: 100%;">
                                            @if (!string.IsNullOrEmpty(prenda.ImagenPrincipal))
                                            {
                                                <img src="@prenda.ImagenPrincipal" alt="@prenda.TituloPublicacion"
                                                    class="position-absolute top-0 start-0 w-100 h-100 rounded-top-4 object-fit-cover" />
                                            }
                                            else
                                            {
                                                <div class="position-absolute top-0 start-0 w-100 h-100 bg-gradient d-flex align-items-center justify-content-center rounded-top-4" style="background: linear-gradient(135deg, #f5f5f4 0%, #fef3c7 100%);">
                                                    <i class="bi bi-image display-4 text-stone-400"></i>
                                                </div>
                                            }

                                            <!-- Boton favorito -->
                                            @if (usuarioActualId > 0)
                                            {
                                                <button @onclick="() => ToggleFavorito(prenda.PrendaId)" @onclick:stopPropagation="true"
                                                    class="position-absolute top-0 end-0 m-2 btn btn-light rounded-circle p-2 py-1 shadow-sm"
                                                    title="@(EsFavorito(prenda.PrendaId) ? "Quitar de favoritos" : "Agregar a favoritos")">
                                                    <i class="bi @(EsFavorito(prenda.PrendaId) ? "bi-heart-fill text-danger" : "bi-heart text-stone-600")"></i>
                                                </button>
                                            }
                                        </div>

                                        <!-- Contenido -->
                                        <div class="card-body p-3">
                                            <h3 class="card-title text-stone-900 fw-medium mb-2 text-truncate small">@prenda.TituloPublicacion</h3>

                                            <div class="d-flex align-items-center gap-2 mb-2">
                                                <span class="badge bg-stone-100 text-stone-700 rounded-pill small">@prenda.Tipo</span>
                                                <span class="badge bg-stone-100 text-stone-700 rounded-pill small">@prenda.Talla</span>
                                            </div>

                                            @if (!string.IsNullOrEmpty(prenda.Ubicacion))
                                            {
                                                <div class="d-flex align-items-center gap-1 small text-stone-600 mb-2">
                                                    <i class="bi bi-geo-alt-fill"></i>
                                                    <span>@prenda.Ubicacion</span>
                                                </div>
                                            }

                                            <div class="d-flex align-items-center justify-content-between">
                                                <span class="badge bg-success-subtle text-success-emphasis rounded-pill px-2 py-1 small">
                                                    @prenda.Estado
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>

                        <!-- Paginacion (RF-07, RNF-01) -->
                        @if (resultado.TotalPaginas > 1)
                        {
                            <nav class="d-flex justify-content-center align-items-center gap-2 mt-5" aria-label="Paginacion">
                                <button @onclick="PaginaAnterior"
                                    class="btn btn-outline-secondary rounded-3"
                                    disabled="@(!resultado.TienePaginaAnterior)">
                                    <i class="bi bi-chevron-left"></i> Anterior
                                </button>

                                @for (int i = GetPaginaInicio(); i <= GetPaginaFin(); i++)
                                {
                                    var pag = i;
                                    <button @onclick="() => IrAPagina(pag)"
                                        class="btn rounded-3 @(pag == resultado.PaginaActual ? "btn-primary text-white" : "btn-outline-secondary")">
                                        @pag
                                    </button>
                                }

                                <button @onclick="PaginaSiguiente"
                                    class="btn btn-outline-secondary rounded-3"
                                    disabled="@(!resultado.TienePaginaSiguiente)">
                                    Siguiente <i class="bi bi-chevron-right"></i>
                                </button>
                            </nav>

                            <div class="text-center mt-3">
                                <span class="small text-stone-500">
                                    Pagina @resultado.PaginaActual de @resultado.TotalPaginas
                                    (@resultado.TotalCount resultados)
                                </span>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="card border-stone-200 rounded-4 shadow text-center">
                            <div class="card-body p-5">
                                <div class="bg-stone-100 rounded-circle mx-auto mb-4 d-flex align-items-center justify-content-center" style="width: 4rem; height: 4rem;">
                                    <i class="bi bi-search display-6 text-stone-600"></i>
                                </div>
                                <h3 class="text-stone-900 fw-medium mb-2">No se encontraron prendas</h3>
                                <p class="text-stone-600 mb-4">
                                    Intenta cambiar los filtros o el termino de busqueda.
                                </p>
                                <button @onclick="LimpiarFiltros" class="btn btn-outline-secondary rounded-3">
                                    Limpiar filtros
                                </button>
                            </div>
                        </div>
                    }
                </div>

                <!-- Mensaje de comunidad -->
                <div class="text-center mt-5">
                    <p class="small text-stone-500 fst-italic">
                        Unete a nuestra comunidad de moda sostenible. Cada trueque reduce el impacto ambiental.
                    </p>
                </div>
            }
        </div>
    </div>

    <!-- Espaciado para navegacion movil -->
    <div class="d-md-none" style="height: 5rem;"></div>
</div>

@code {
    // Injected services
    [Inject] private NavigationManager NavigationManager { get; set; } = default!;
    [Inject] private IExplorarService ExplorarService { get; set; } = default!;
    [Inject] private IFavoritosService FavoritosService { get; set; } = default!;
    [Inject] private AutenticacionService AutenticacionService { get; set; } = default!;

    // Search and filter state
    private string terminoBusqueda = "";
    private int categoriaId = 0;
    private string tallaSeleccionada = "";
    private int estadoPrendaId = 0;
    private int regionId = 0;
    private bool mostrarFiltros = false;

    // Filter options
    private List<CategoriaPrenda> categorias = new();
    private List<string> tallas = new();
    private List<EstadoPrenda> estadosPrenda = new();
    private List<Region> regiones = new();

    // Results
    private PaginacionResultado<Prenda> resultado = new(
        Items: new List<Prenda>(),
        TotalCount: 0,
        PaginaActual: 1,
        TotalPaginas: 0,
        TienePaginaAnterior: false,
        TienePaginaSiguiente: false
    );

    // UI state
    private bool cargando = true;
    private int paginaActual = 1;

    // Favoritos state
    private int usuarioActualId = 0;
    private HashSet<int> favoritosIds = new();

    protected override async Task OnInitializedAsync()
    {
        // Cargar usuario actual para favoritos
        var usuario = await AutenticacionService.GetCurrentUser();
        if (usuario != null)
        {
            usuarioActualId = usuario.UsuarioId;
            favoritosIds = await FavoritosService.ObtenerIdsFavoritos(usuarioActualId);
        }

        await CargarFiltros();
        await Buscar();
    }

    private async Task CargarFiltros()
    {
        var categoriasTask = ExplorarService.ObtenerCategorias();
        var tallasTask = ExplorarService.ObtenerTallas();
        var estadosTask = ExplorarService.ObtenerEstadosPrenda();
        var regionesTask = ExplorarService.ObtenerRegiones();

        await Task.WhenAll(categoriasTask, tallasTask, estadosTask, regionesTask);

        categorias = await categoriasTask;
        tallas = await tallasTask;
        estadosPrenda = await estadosTask;
        regiones = await regionesTask;
    }

    private async Task Buscar()
    {
        cargando = true;
        paginaActual = 1;

        resultado = await ExplorarService.BuscarPrendas(
            busqueda: string.IsNullOrWhiteSpace(terminoBusqueda) ? null : terminoBusqueda,
            categoriaId: categoriaId > 0 ? categoriaId : null,
            talla: string.IsNullOrWhiteSpace(tallaSeleccionada) ? null : tallaSeleccionada,
            estadoPrendaId: estadoPrendaId > 0 ? estadoPrendaId : null,
            regionId: regionId > 0 ? regionId : null,
            pagina: paginaActual
        );

        cargando = false;
    }

    private async Task OnBusquedaKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await Buscar();
        }
    }

    private async Task LimpiarFiltros()
    {
        terminoBusqueda = "";
        categoriaId = 0;
        tallaSeleccionada = "";
        estadoPrendaId = 0;
        regionId = 0;
        await Buscar();
    }

    private async Task IrAPagina(int pagina)
    {
        if (pagina < 1 || pagina > resultado.TotalPaginas) return;

        cargando = true;
        paginaActual = pagina;

        resultado = await ExplorarService.BuscarPrendas(
            busqueda: string.IsNullOrWhiteSpace(terminoBusqueda) ? null : terminoBusqueda,
            categoriaId: categoriaId > 0 ? categoriaId : null,
            talla: string.IsNullOrWhiteSpace(tallaSeleccionada) ? null : tallaSeleccionada,
            estadoPrendaId: estadoPrendaId > 0 ? estadoPrendaId : null,
            regionId: regionId > 0 ? regionId : null,
            pagina: paginaActual
        );

        cargando = false;
    }

    private async Task PaginaAnterior()
    {
        if (resultado.TienePaginaAnterior)
        {
            await IrAPagina(resultado.PaginaActual - 1);
        }
    }

    private async Task PaginaSiguiente()
    {
        if (resultado.TienePaginaSiguiente)
        {
            await IrAPagina(resultado.PaginaActual + 1);
        }
    }

    private int GetPaginaInicio()
    {
        var inicio = Math.Max(1, resultado.PaginaActual - 2);
        return Math.Min(inicio, Math.Max(1, resultado.TotalPaginas - 4));
    }

    private int GetPaginaFin()
    {
        return Math.Min(resultado.TotalPaginas, GetPaginaInicio() + 4);
    }

    private void ToggleFiltros()
    {
        mostrarFiltros = !mostrarFiltros;
    }

    private void VerDetallePrenda(int id)
    {
        NavigationManager.NavigateTo($"/detalle-prenda/{id}");
    }

    private bool EsFavorito(int prendaId)
    {
        return favoritosIds.Contains(prendaId);
    }

    private async Task ToggleFavorito(int prendaId)
    {
        if (usuarioActualId == 0) return;

        var nuevoEstado = await FavoritosService.ToggleFavorito(usuarioActualId, prendaId);

        if (nuevoEstado)
        {
            favoritosIds.Add(prendaId);
        }
        else
        {
            favoritosIds.Remove(prendaId);
        }
    }
}
