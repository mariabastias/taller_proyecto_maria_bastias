@page "/detalle-prenda/{prendaId:int}"
@rendermode InteractiveServer
@attribute [Authorize]
@using TruequeTextil.Features.DetallePrenda.Interfaces
@using TruequeTextil.Shared.Models

<div class="min-vh-100 bg-stone-50 py-4">
    <div class="container">
        @if (isLoading)
        {
            <div class="text-center py-5">
                <div class="spinner-border text-amber-500" role="status">
                    <span class="visually-hidden">Cargando prenda...</span>
                </div>
            </div>
        }
        else if (prenda == null)
        {
            <div class="text-center py-5">
                <div class="bg-white rounded-4 shadow p-4">
                    <i class="bi bi-shirt text-stone-400" style="font-size: 48px;"></i>
                    <h3 class="mt-3 text-stone-600">Prenda no encontrada</h3>
                    <p class="text-stone-500">La prenda que buscas no existe o no está disponible.</p>
                    <button @onclick="VolverAExplorar" class="btn btn-primary mt-3">
                        Volver a explorar
                    </button>
                </div>
            </div>
        }
        else
        {
            <!-- Breadcrumb -->
            <nav aria-label="breadcrumb" class="mb-4">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/explorar" class="text-decoration-none">Explorar</a></li>
                    <li class="breadcrumb-item"><a href="/perfil-publico/@prenda.UsuarioId" class="text-decoration-none">@prenda.Usuario?.Nombre</a></li>
                    <li class="breadcrumb-item active">@prenda.Titulo</li>
                </ol>
            </nav>

            <div class="row g-4">
                <!-- Galería de imágenes -->
                <div class="col-lg-8">
                    <div class="bg-white rounded-4 shadow p-4">
                        @if (imagenes.Count > 0)
                        {
                            <div id="carouselPrenda" class="carousel slide" data-bs-ride="carousel">
                                <div class="carousel-inner rounded-3">
                                    @for (int i = 0; i < imagenes.Count; i++)
                                    {
                                        var imagen = imagenes[i];
                                        <div class="carousel-item @(i == 0 ? "active" : "")">
                                            <img src="@imagen" class="d-block w-100 rounded-3"
                                                 style="max-height: 500px; object-fit: cover;" alt="Imagen de prenda" />
                                        </div>
                                    }
                                </div>
                                @if (imagenes.Count > 1)
                                {
                                    <button class="carousel-control-prev" type="button" data-bs-target="#carouselPrenda" data-bs-slide="prev">
                                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                        <span class="visually-hidden">Previous</span>
                                    </button>
                                    <button class="carousel-control-next" type="button" data-bs-target="#carouselPrenda" data-bs-slide="next">
                                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                        <span class="visually-hidden">Next</span>
                                    </button>
                                }
                            </div>
                            @if (imagenes.Count > 1)
                            {
                                <div class="mt-3 d-flex justify-content-center gap-2">
                                    @for (int i = 0; i < imagenes.Count; i++)
                                    {
                                        var imagen = imagenes[i];
                                        <button type="button" data-bs-target="#carouselPrenda" data-bs-slide-to="@i"
                                                class="@(i == 0 ? "active" : "") bg-stone-300 rounded-circle border-0"
                                                style="width: 40px; height: 40px; background-size: cover; background-image: url('@imagen');">
                                        </button>
                                    }
                                </div>
                            }
                        }
                        else
                        {
                            <div class="text-center py-5">
                                <i class="bi bi-image text-stone-400" style="font-size: 64px;"></i>
                                <p class="text-stone-500 mt-3">No hay imágenes disponibles</p>
                            </div>
                        }
                    </div>
                </div>

                <!-- Detalles -->
                <div class="col-lg-4">
                    <div class="bg-white rounded-4 shadow p-4">
                        <h1 class="fs-4 fw-bold text-stone-900 mb-3">@prenda.Titulo</h1>

                        <div class="mb-3">
                            <span class="badge bg-amber-100 text-amber-800">@prenda.Tipo</span>
                            <span class="badge bg-stone-100 text-stone-700 ms-2">@prenda.Talla</span>
                            @if (!prenda.Disponible)
                            {
                                <span class="badge bg-secondary ms-2">No disponible</span>
                            }
                        </div>

                        <div class="mb-3">
                            <h5 class="fs-6 fw-bold text-stone-900 mb-2">Publicado por</h5>
                            <div class="d-flex align-items-center">
                                <img src="@(string.IsNullOrEmpty(prenda.Usuario?.UrlFotoPerfil) ? "/images/default-avatar.png" : prenda.Usuario?.UrlFotoPerfil)"
                                     class="rounded-circle me-3 border border-2 border-stone-200"
                                     style="width: 40px; height: 40px; object-fit: cover;" />
                                <div>
                                    <a href="/perfil-publico/@prenda.UsuarioId" class="text-decoration-none fw-medium text-stone-900">
                                        @prenda.Usuario?.Nombre @prenda.Usuario?.Apellido
                                    </a>
                                    <div class="small text-stone-500">
                                        <i class="bi bi-geo-alt me-1"></i>
                                        @prenda.Ubicacion
                                    </div>
                                </div>
                            </div>
                        </div>

                        @if (esPropia)
                        {
                            <button @onclick="EditarPrenda" class="btn btn-outline-primary w-100 mb-3">
                                <i class="bi bi-pencil me-1"></i>
                                Editar prenda
                            </button>
                        }
                        else
                        {
                            <button @onclick="ProponerTrueque" class="btn btn-primary w-100 mb-3">
                                <i class="bi bi-arrow-left-right me-1"></i>
                                Proponer trueque
                            </button>
                        }
                    </div>
                </div>
            </div>

            <!-- Descripción -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="bg-white rounded-4 shadow p-4">
                        <h3 class="fs-5 fw-bold text-stone-900 mb-3">Descripción</h3>
                        <p class="text-stone-700 mb-0">@prenda.Descripcion</p>
                    </div>
                </div>
            </div>

            <!-- Prendas similares -->
            @if (prendasSimilares.Count > 0)
            {
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="bg-white rounded-4 shadow p-4">
                            <h3 class="fs-5 fw-bold text-stone-900 mb-4">Prendas similares</h3>

                            <div class="row g-3">
                                @foreach (var similar in prendasSimilares.Take(4))
                                {
                                    <div class="col-6 col-md-3">
                                        <div class="card border-0 shadow-sm h-100">
                                            <img src="@similar.ImagenPrincipal" class="card-img-top rounded-top"
                                                 style="height: 150px; object-fit: cover;" />
                                            <div class="card-body d-flex flex-column">
                                                <h6 class="card-title fw-bold text-stone-900 mb-1">@similar.Titulo</h6>
                                                <p class="card-text text-stone-600 small mb-2">@similar.Tipo</p>
                                                <button @onclick="() => VerDetalle(similar.PrendaId)"
                                                        class="btn btn-outline-primary btn-sm w-100 mt-auto">
                                                    Ver
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
        }
    </div>
</div>

@code {
    [Parameter] public int PrendaId { get; set; }

    private Prenda? prenda;
    private List<string> imagenes = new();
    private List<Prenda> prendasSimilares = new();
    private bool isLoading = true;
    private bool esPropia = false;

    protected override async Task OnParametersSetAsync()
    {
        await LoadPrenda();
    }

    private async Task LoadPrenda()
    {
        isLoading = true;

        try
        {
            prenda = await DetallePrendaService.ObtenerDetallePrenda(PrendaId);
            if (prenda != null)
            {
                imagenes = await DetallePrendaService.ObtenerImagenesPrenda(PrendaId);
                prendasSimilares = await DetallePrendaService.ObtenerPrendasSimilares(PrendaId);
                await DetallePrendaService.RegistrarVista(PrendaId);

                // Verificar si es propia
                var currentUser = await AuthenticationStateProvider.GetCurrentUserAsync();
                esPropia = currentUser?.UsuarioId == prenda.UsuarioId;
            }
        }
        catch (Exception ex)
        {
			Console.WriteLine($"Error al cargar la prenda: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void VerDetalle(int prendaId)
    {
        NavigationManager.NavigateTo($"/detalle-prenda/{prendaId}");
    }

    private void ProponerTrueque()
    {
        NavigationManager.NavigateTo($"/proponer-trueque/{PrendaId}");
    }

    private void EditarPrenda()
    {
        NavigationManager.NavigateTo($"/editar-prenda/{PrendaId}");
    }

    private void VolverAExplorar()
    {
        NavigationManager.NavigateTo("/explorar");
    }

    [Inject]
    private NavigationManager NavigationManager { get; set; } = default!;

    [Inject]
    private IDetallePrendaService DetallePrendaService { get; set; } = default!;

    [Inject]
    private CustomAuthenticationStateProvider AuthenticationStateProvider { get; set; } = default!;
}