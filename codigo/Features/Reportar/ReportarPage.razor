@page "/reportar/{tipo:int}/{id:int}"
@attribute [Authorize]
@rendermode InteractiveServer
@using TruequeTextil.Features.Reportar.Interfaces
@using TruequeTextil.Shared.Models
@using TruequeTextil.Shared.Services

<div class="min-vh-100 bg-stone-50">
    <!-- Header -->
    <div class="bg-white border-bottom border-stone-200 sticky-top">
        <div class="container" style="max-width: 768px;">
            <div class="px-4 py-3 d-flex align-items-center justify-content-between">
                <button @onclick="VolverAtras"
                    class="btn btn-link text-stone-600 text-decoration-none d-flex align-items-center gap-2 p-0">
                    <i class="bi bi-arrow-left"></i>
                    <span class="small">Volver</span>
                </button>

                <h1 class="h6 fw-semibold text-stone-900 mb-0">Reportar</h1>

                <div style="width: 4rem;"></div>
            </div>
        </div>
    </div>

    <!-- Contenido principal -->
    <div class="container" style="max-width: 768px;">
        <div class="p-4">
            @if (cargando)
            {
                <div class="text-center py-5">
                    <div class="spinner-border text-amber-600" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>
            }
            else if (elementoNoEncontrado)
            {
                <!-- Elemento no encontrado -->
                <div class="card rounded-4 shadow text-center p-5">
                    <div class="bg-danger bg-opacity-10 rounded-circle mx-auto mb-4 d-flex align-items-center justify-content-center" style="width: 5rem; height: 5rem;">
                        <i class="bi bi-exclamation-triangle-fill text-danger" style="font-size: 2.5rem;"></i>
                    </div>
                    <h2 class="text-stone-900 fw-bold mb-3">@tipoElementoTexto no encontrado</h2>
                    <p class="text-stone-600 mb-4">El @tipoElementoTexto.ToLower() que intentas reportar no existe o no está disponible.</p>
                    <button @onclick="VolverAtras" class="btn btn-primary rounded-3 px-4">
                        <i class="bi bi-arrow-left me-2"></i>Volver
                    </button>
                </div>
            }
            else if (noPuedeReportar)
            {
                <!-- No puede reportar -->
                <div class="card rounded-4 shadow text-center p-5">
                    <div class="bg-warning bg-opacity-10 rounded-circle mx-auto mb-4 d-flex align-items-center justify-content-center" style="width: 5rem; height: 5rem;">
                        <i class="bi bi-info-circle-fill text-warning" style="font-size: 2.5rem;"></i>
                    </div>
                    <h2 class="text-stone-900 fw-bold mb-3">No puedes reportar</h2>
                    <p class="text-stone-600 mb-4">@mensajeNoPuedeReportar</p>
                    <button @onclick="VolverAtras" class="btn btn-primary rounded-3 px-4">
                        <i class="bi bi-arrow-left me-2"></i>Volver
                    </button>
                </div>
            }
            else if (reporteEnviado)
            {
                <!-- Reporte enviado exitosamente -->
                <div class="card rounded-4 shadow text-center p-5">
                    <div class="bg-success bg-opacity-10 rounded-circle mx-auto mb-4 d-flex align-items-center justify-content-center" style="width: 5rem; height: 5rem;">
                        <i class="bi bi-check-circle-fill text-success" style="font-size: 2.5rem;"></i>
                    </div>
                    <h2 class="text-stone-900 fw-bold mb-3">Reporte enviado</h2>
                    <p class="text-stone-600 mb-4">@mensajeExito</p>
                    <p class="text-stone-500 small mb-4">
                        Nuestro equipo revisará tu reporte y tomará las medidas necesarias.
                        Gracias por ayudarnos a mantener una comunidad segura.
                    </p>
                    <div class="d-flex gap-3 justify-content-center flex-wrap">
                        <button @onclick="VolverAtras" class="btn btn-primary rounded-3 px-4">
                            <i class="bi bi-arrow-left me-2"></i>Volver
                        </button>
                        <button @onclick="VerMisReportes" class="btn btn-outline-secondary rounded-3 px-4">
                            <i class="bi bi-list-check me-2"></i>Ver mis reportes
                        </button>
                    </div>
                </div>
            }
            else
            {
                <!-- Formulario de reporte -->
                @if (!string.IsNullOrEmpty(mensajeError))
                {
                    <div class="alert alert-danger rounded-3 mb-4">
                        <i class="bi bi-exclamation-triangle me-2"></i>@mensajeError
                    </div>
                }

                <!-- Info del elemento a reportar -->
                <div class="card rounded-4 shadow mb-4">
                    <div class="card-body p-4">
                        <div class="d-flex align-items-center gap-3 mb-3">
                            <div class="@GetTipoIconClass() rounded-circle d-flex align-items-center justify-content-center" style="width: 2.5rem; height: 2.5rem;">
                                <i class="bi @GetTipoIcon() text-white"></i>
                            </div>
                            <div>
                                <h2 class="text-stone-900 fw-medium mb-0">Reportar @tipoElementoTexto</h2>
                                <p class="text-stone-500 small mb-0">Los reportes nos ayudan a mantener la comunidad segura</p>
                            </div>
                        </div>

                        @if (tipoReporte == TipoReporte.Usuario && usuarioReportado != null)
                        {
                            <div class="d-flex align-items-center gap-3 p-3 bg-stone-50 rounded-3">
                                @if (!string.IsNullOrEmpty(usuarioReportado.UrlFotoPerfil))
                                {
                                    <img src="@usuarioReportado.UrlFotoPerfil" alt="@usuarioReportado.Nombre"
                                         class="rounded-circle border border-2 border-stone-200"
                                         style="width: 3.5rem; height: 3.5rem; object-fit: cover;" />
                                }
                                else
                                {
                                    <div class="bg-amber-600 rounded-circle d-flex align-items-center justify-content-center text-white fw-medium"
                                         style="width: 3.5rem; height: 3.5rem;">
                                        @GetIniciales(usuarioReportado.Nombre)
                                    </div>
                                }
                                <div>
                                    <p class="text-stone-900 fw-medium mb-0">@usuarioReportado.Nombre @usuarioReportado.Apellido</p>
                                    <div class="d-flex align-items-center gap-1">
                                        @for (int i = 1; i <= 5; i++)
                                        {
                                            <i class="bi @(i <= Math.Round(usuarioReportado.ReputacionPromedio) ? "bi-star-fill text-amber-500" : "bi-star text-stone-300")" style="font-size: 0.75rem;"></i>
                                        }
                                        <span class="text-stone-500 small ms-1">@usuarioReportado.ReputacionPromedio.ToString("F1")</span>
                                    </div>
                                </div>
                            </div>
                        }
                        else if (tipoReporte == TipoReporte.Prenda && prendaReportada != null)
                        {
                            <div class="d-flex align-items-center gap-3 p-3 bg-stone-50 rounded-3">
                                @if (!string.IsNullOrEmpty(prendaReportada.ImagenPrincipal))
                                {
                                    <img src="@prendaReportada.ImagenPrincipal" alt="@prendaReportada.TituloPublicacion"
                                         class="rounded-3 border border-stone-200"
                                         style="width: 4rem; height: 4rem; object-fit: cover;" />
                                }
                                else
                                {
                                    <div class="bg-stone-200 rounded-3 d-flex align-items-center justify-content-center"
                                         style="width: 4rem; height: 4rem;">
                                        <i class="bi bi-image text-stone-400 fs-4"></i>
                                    </div>
                                }
                                <div class="flex-grow-1">
                                    <p class="text-stone-900 fw-medium mb-1">@prendaReportada.TituloPublicacion</p>
                                    <div class="d-flex gap-2 mb-1">
                                        <span class="badge bg-amber-100 text-amber-800 small">@prendaReportada.Tipo</span>
                                        <span class="badge bg-stone-100 text-stone-700 small">@prendaReportada.Talla</span>
                                    </div>
                                    <p class="text-stone-500 small mb-0">
                                        Por @prendaReportada.Usuario?.Nombre @prendaReportada.Usuario?.Apellido
                                    </p>
                                </div>
                            </div>
                        }
                    </div>
                </div>

                <!-- Seleccionar motivo -->
                <div class="card rounded-4 shadow mb-4">
                    <div class="card-body p-4">
                        <div class="d-flex align-items-center gap-3 mb-4">
                            <div class="bg-amber-100 rounded-circle d-flex align-items-center justify-content-center" style="width: 2rem; height: 2rem;">
                                <span class="text-amber-700 fw-bold small">1</span>
                            </div>
                            <h3 class="text-stone-900 fw-medium mb-0">Selecciona el motivo del reporte</h3>
                        </div>

                        <div class="d-flex flex-column gap-2">
                            @foreach (var categoria in categorias)
                            {
                                var isSelected = motivoSeleccionado == categoria.Nombre;
                                <button @onclick="() => SeleccionarMotivo(categoria.Nombre)"
                                        class="btn text-start p-3 rounded-3 border @(isSelected ? "border-amber-500 bg-amber-50" : "border-stone-200 bg-white") d-flex align-items-start gap-3">
                                    <div class="@(isSelected ? "bg-amber-500" : "bg-stone-200") rounded-circle d-flex align-items-center justify-content-center flex-shrink-0" style="width: 1.5rem; height: 1.5rem;">
                                        @if (isSelected)
                                        {
                                            <i class="bi bi-check text-white small"></i>
                                        }
                                    </div>
                                    <div class="text-start">
                                        <p class="fw-medium mb-0 @(isSelected ? "text-amber-800" : "text-stone-900")">@categoria.Nombre</p>
                                        @if (!string.IsNullOrEmpty(categoria.Descripcion))
                                        {
                                            <p class="small mb-0 @(isSelected ? "text-amber-700" : "text-stone-500")">@categoria.Descripcion</p>
                                        }
                                    </div>
                                </button>
                            }
                        </div>

                        @if (string.IsNullOrEmpty(motivoSeleccionado) && mostrarValidacion)
                        {
                            <div class="text-danger small mt-2">
                                <i class="bi bi-exclamation-circle me-1"></i>
                                Selecciona un motivo para continuar
                            </div>
                        }
                    </div>
                </div>

                <!-- Descripcion adicional -->
                <div class="card rounded-4 shadow mb-4">
                    <div class="card-body p-4">
                        <div class="d-flex align-items-center gap-3 mb-4">
                            <div class="bg-amber-100 rounded-circle d-flex align-items-center justify-content-center" style="width: 2rem; height: 2rem;">
                                <span class="text-amber-700 fw-bold small">2</span>
                            </div>
                            <h3 class="text-stone-900 fw-medium mb-0">Describe el problema (opcional)</h3>
                        </div>

                        <p class="text-stone-600 mb-3 small">
                            Proporciona detalles adicionales que nos ayuden a entender mejor la situacion.
                        </p>

                        <textarea @bind="descripcion" maxlength="500"
                                  class="form-control rounded-3 focus-ring-amber" rows="4"
                                  placeholder="Explica con mas detalle lo que sucedio. Por ejemplo: fecha, contexto, conversaciones previas, etc."></textarea>
                        <small class="text-stone-500">@descripcion.Length/500 caracteres</small>
                    </div>
                </div>

                <!-- Aviso importante -->
                <div class="card rounded-4 border-warning mb-4" style="background: linear-gradient(90deg, #fef3c7 0%, #f5f5f4 100%);">
                    <div class="card-body p-4">
                        <div class="d-flex align-items-start gap-3">
                            <i class="bi bi-info-circle-fill fs-4 text-amber-600"></i>
                            <div>
                                <h4 class="text-stone-900 fw-medium mb-2 small">Antes de enviar tu reporte</h4>
                                <ul class="text-stone-700 small mb-0 ps-3">
                                    <li class="mb-1">Los reportes falsos pueden resultar en suspension de tu cuenta</li>
                                    <li class="mb-1">Nuestro equipo revisara el reporte en un plazo de 24-48 horas</li>
                                    <li>Puedes ver el estado de tus reportes en tu perfil</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Botones de accion -->
                <div class="d-grid gap-2">
                    <button @onclick="EnviarReporte"
                            class="btn btn-danger text-white rounded-3 py-3 fw-medium"
                            disabled="@enviando">
                        @if (enviando)
                        {
                            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                            <span>Enviando reporte...</span>
                        }
                        else
                        {
                            <i class="bi bi-flag me-2"></i>
                            <span>Enviar reporte</span>
                        }
                    </button>

                    <button @onclick="VolverAtras" class="btn btn-outline-secondary rounded-3 py-2">
                        Cancelar
                    </button>
                </div>

                <!-- Historial de reportes -->
                @if (misReportes.Any())
                {
                    <div class="mt-5">
                        <h4 class="text-stone-900 fw-medium mb-3">
                            <i class="bi bi-clock-history text-amber-500 me-2"></i>
                            Mis reportes recientes
                        </h4>

                        <div class="d-flex flex-column gap-2">
                            @foreach (var reporte in misReportes.Take(3))
                            {
                                <div class="card border-stone-200 rounded-3">
                                    <div class="card-body p-3">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <div class="d-flex align-items-center gap-2">
                                                <div class="@GetTipoReporteBadgeClass(reporte.Tipo) rounded-circle d-flex align-items-center justify-content-center" style="width: 2rem; height: 2rem;">
                                                    <i class="bi @GetTipoReporteIcon(reporte.Tipo) text-white small"></i>
                                                </div>
                                                <div>
                                                    <p class="text-stone-900 small fw-medium mb-0">@reporte.Motivo</p>
                                                    <p class="text-stone-500 mb-0" style="font-size: 0.7rem;">@FormatearFecha(reporte.FechaCreacion)</p>
                                                </div>
                                            </div>
                                            <span class="badge @GetEstadoBadgeClass(reporte.Estado) rounded-pill px-2 py-1 small">
                                                @GetEstadoTexto(reporte.Estado)
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>

                        @if (misReportes.Count > 3)
                        {
                            <button @onclick="VerMisReportes" class="btn btn-link text-amber-600 text-decoration-none p-0 mt-2">
                                Ver todos mis reportes (@misReportes.Count)
                                <i class="bi bi-arrow-right ms-1"></i>
                            </button>
                        }
                    </div>
                }
            }
        </div>
    </div>

    <!-- Espaciado para navegacion movil -->
    <div class="d-md-none" style="height: 5rem;"></div>
</div>

@code {
    [Parameter] public int Tipo { get; set; }
    [Parameter] public int Id { get; set; }

    [Inject] private NavigationManager NavigationManager { get; set; } = default!;
    [Inject] private IReportarService ReportarService { get; set; } = default!;
    [Inject] private AutenticacionService AutenticacionService { get; set; } = default!;

    // Estado
    private bool cargando = true;
    private bool enviando = false;
    private bool elementoNoEncontrado = false;
    private bool noPuedeReportar = false;
    private bool reporteEnviado = false;
    private bool mostrarValidacion = false;

    // Mensajes
    private string mensajeError = string.Empty;
    private string mensajeExito = string.Empty;
    private string mensajeNoPuedeReportar = string.Empty;
    private string tipoElementoTexto = string.Empty;

    // Datos
    private TipoReporte tipoReporte;
    private Usuario? usuarioActual;
    private Usuario? usuarioReportado;
    private Prenda? prendaReportada;
    private List<CategoriaReporteDTO> categorias = new();
    private List<Reporte> misReportes = new();

    // Formulario
    private string motivoSeleccionado = string.Empty;
    private string descripcion = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await CargarDatos();
    }

    private async Task CargarDatos()
    {
        try
        {
            cargando = true;

            // Obtener usuario actual
            usuarioActual = await AutenticacionService.GetCurrentUser();
            if (usuarioActual == null)
            {
                NavigationManager.NavigateTo("/login");
                return;
            }

            // Determinar tipo de reporte
            tipoReporte = Tipo switch
            {
                1 => TipoReporte.Usuario,
                2 => TipoReporte.Prenda,
                _ => TipoReporte.Usuario
            };

            tipoElementoTexto = tipoReporte == TipoReporte.Usuario ? "Usuario" : "Prenda";

            // Cargar elemento a reportar
            if (tipoReporte == TipoReporte.Usuario)
            {
                usuarioReportado = await ReportarService.ObtenerUsuarioPorId(Id);
                if (usuarioReportado == null)
                {
                    elementoNoEncontrado = true;
                    return;
                }

                // Verificar si puede reportar
                if (usuarioActual.UsuarioId == Id)
                {
                    noPuedeReportar = true;
                    mensajeNoPuedeReportar = "No puedes reportarte a ti mismo.";
                    return;
                }
            }
            else
            {
                prendaReportada = await ReportarService.ObtenerPrendaPorId(Id);
                if (prendaReportada == null)
                {
                    elementoNoEncontrado = true;
                    return;
                }

                // Verificar si puede reportar
                if (prendaReportada.UsuarioId == usuarioActual.UsuarioId)
                {
                    noPuedeReportar = true;
                    mensajeNoPuedeReportar = "No puedes reportar tu propia prenda.";
                    return;
                }
            }

            // Verificar si ya tiene reporte activo
            var puedeReportar = await ReportarService.PuedeReportar(usuarioActual.UsuarioId, tipoReporte, Id);
            if (!puedeReportar)
            {
                noPuedeReportar = true;
                mensajeNoPuedeReportar = $"Ya tienes un reporte activo para este {tipoElementoTexto.ToLower()}. Espera a que sea revisado.";
                return;
            }

            // Cargar categorias de reporte
            categorias = await ReportarService.ObtenerCategoriasReporte(tipoReporte);

            // Cargar historial de reportes del usuario
            misReportes = await ReportarService.ObtenerMisReportes(usuarioActual.UsuarioId);
        }
        catch (Exception ex)
        {
            mensajeError = "Error al cargar los datos. Intenta nuevamente.";
            Console.WriteLine($"Error: {ex.Message}");
        }
        finally
        {
            cargando = false;
        }
    }

    private void SeleccionarMotivo(string motivo)
    {
        motivoSeleccionado = motivo;
        mostrarValidacion = false;
    }

    private async Task EnviarReporte()
    {
        if (enviando) return;

        // Validar formulario
        if (string.IsNullOrEmpty(motivoSeleccionado))
        {
            mostrarValidacion = true;
            return;
        }

        mensajeError = string.Empty;
        enviando = true;

        try
        {
            (bool exito, string mensaje) result;

            if (tipoReporte == TipoReporte.Usuario)
            {
                result = await ReportarService.ReportarUsuario(
                    usuarioActual!.UsuarioId,
                    Id,
                    motivoSeleccionado,
                    string.IsNullOrWhiteSpace(descripcion) ? null : descripcion.Trim()
                );
            }
            else
            {
                result = await ReportarService.ReportarPrenda(
                    usuarioActual!.UsuarioId,
                    Id,
                    motivoSeleccionado,
                    string.IsNullOrWhiteSpace(descripcion) ? null : descripcion.Trim()
                );
            }

            if (result.exito)
            {
                reporteEnviado = true;
                mensajeExito = result.mensaje;
            }
            else
            {
                mensajeError = result.mensaje;
            }
        }
        catch (Exception ex)
        {
            mensajeError = "Ocurrio un error al enviar el reporte. Intenta nuevamente.";
            Console.WriteLine($"Error: {ex.Message}");
        }
        finally
        {
            enviando = false;
        }
    }

    private void VolverAtras()
    {
        if (tipoReporte == TipoReporte.Usuario)
        {
            NavigationManager.NavigateTo($"/perfil-publico/{Id}");
        }
        else
        {
            NavigationManager.NavigateTo($"/detalle-prenda/{Id}");
        }
    }

    private void VerMisReportes()
    {
        NavigationManager.NavigateTo("/mis-reportes");
    }

    private string GetIniciales(string? nombre)
    {
        if (string.IsNullOrEmpty(nombre)) return "?";
        var partes = nombre.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (partes.Length >= 2)
            return $"{partes[0][0]}{partes[1][0]}".ToUpper();
        return nombre.Length >= 2 ? nombre[..2].ToUpper() : nombre.ToUpper();
    }

    private string GetTipoIconClass()
    {
        return tipoReporte == TipoReporte.Usuario ? "bg-info" : "bg-amber-600";
    }

    private string GetTipoIcon()
    {
        return tipoReporte == TipoReporte.Usuario ? "bi-person" : "bi-bag";
    }

    private string GetTipoReporteBadgeClass(TipoReporte tipo)
    {
        return tipo switch
        {
            TipoReporte.Usuario => "bg-info",
            TipoReporte.Prenda => "bg-amber-600",
            _ => "bg-stone-600"
        };
    }

    private string GetTipoReporteIcon(TipoReporte tipo)
    {
        return tipo switch
        {
            TipoReporte.Usuario => "bi-person",
            TipoReporte.Prenda => "bi-bag",
            _ => "bi-flag"
        };
    }

    private string GetEstadoBadgeClass(EstadoReporte estado)
    {
        return estado switch
        {
            EstadoReporte.Pendiente => "bg-warning-subtle text-warning",
            EstadoReporte.Revisado => "bg-info-subtle text-info",
            EstadoReporte.Resuelto => "bg-success-subtle text-success",
            EstadoReporte.Desestimado => "bg-danger-subtle text-danger",
            _ => "bg-secondary-subtle text-secondary"
        };
    }

    private string GetEstadoTexto(EstadoReporte estado)
    {
        return estado switch
        {
            EstadoReporte.Pendiente => "Pendiente",
            EstadoReporte.Revisado => "En revision",
            EstadoReporte.Resuelto => "Resuelto",
            EstadoReporte.Desestimado => "Desestimado",
            _ => "Desconocido"
        };
    }

    private string FormatearFecha(DateTime fecha)
    {
        var diferencia = DateTime.Now - fecha;
        if (diferencia.TotalMinutes < 60)
            return $"Hace {(int)diferencia.TotalMinutes} min";
        if (diferencia.TotalHours < 24)
            return $"Hace {(int)diferencia.TotalHours} horas";
        if (diferencia.TotalDays < 7)
            return $"Hace {(int)diferencia.TotalDays} dias";
        return fecha.ToString("dd/MM/yyyy");
    }
}
